<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Management System</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        .container {
            margin-top: 50px;
        }
    </style>
</head>

<body>

    <div class="container">
        <!-- Login Form -->
        <div id="loginSection">
            <h2>Login</h2>
            <form id="loginForm">
                <div class="form-group">
                    <label for="username">Username:</label>
                    <input type="text" class="form-control" id="username" placeholder="Enter username">
                </div>
                <div class="form-group">
                    <label for="password">Password:</label>
                    <input type="password" class="form-control" id="password" placeholder="Enter password">
                </div>
                <button type="button" class="btn btn-primary" onclick="login()">Login</button>
            </form>
        </div>

        <!-- Logout Button -->
        <div id="logoutSection" style="display: none;">
            <button type="button" class="btn btn-secondary" onclick="logout()">Logout</button>
        </div>

        <br>

        <h2>Add New Book</h2>
        <form id="addBookForm">
            <div class="form-group">
                <label for="name">name:</label>
                <input type="text" class="form-control" id="name" placeholder="Enter name">
            </div>
            <div class="form-group">
                <label for="author">Author:</label>
                <input type="text" class="form-control" id="author" placeholder="Enter author">
            </div>
            <div class="form-group">
                <label for="year">Year:</label>
                <input type="number" class="form-control" id="year" placeholder="Enter year">
            </div>
            <div class="mb-3">
                <label for="image" class="form-label">Book Image (Optional):</label>
                <input type="file" id="image" name="image" class="form-control">
            </div>
            <button type="button" class="btn btn-primary" onclick="addBook()">Add Book</button>
        </form>

        <h2>Books</h2>
        <div id="booksList"></div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script>

        MY_SERVER = 'http://127.0.0.1:8000/';

        // Function to toggle login form visibility
        // Function to toggle login/logout sections
        function toggleSections(loggedIn) {
            const loginSection = document.getElementById('loginSection');
            const logoutSection = document.getElementById('logoutSection');
            loginSection.style.display = loggedIn ? 'none' : 'block';
            logoutSection.style.display = loggedIn ? 'block' : 'none';
        }

        // Function to check if user is logged in
        function checkLoggedIn() {
            const token = localStorage.getItem('token');
            if (token) {
                setAuthorizationHeader(token);
                toggleSections(true);
                getBooks();
            }
        }

        // Function to perform login
        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            axios.post(`${MY_SERVER}login`, { username, password })
                .then(response => {
                    const token = response.data.access; // Assuming the server returns a token upon successful login
                    localStorage.setItem('token', token);
                    setAuthorizationHeader(token);
                    Toastify({
                        text: 'Login successful',
                        backgroundColor: 'green',
                    }).showToast();
                    toggleSections(true);
                    getBooks();
                })
                .catch(error => {
                    Toastify({
                        text: 'Login failed',
                        backgroundColor: 'red',
                    }).showToast();
                    console.error('Login error:', error);
                });
        }

        // Function to perform logout
        function logout() {
            localStorage.removeItem('token');
            toggleSections(false);
            location.reload(); // Refresh the page to clear the books list
        }

        function setAuthorizationHeader(token) {
            axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;
        }

        const getBooks = async () => {
            const token = localStorage.getItem('token');
            if (!token) {
                // If token is not available, redirect the user to the login page or show a login prompt
                return;
            }

            await axios.get(`${MY_SERVER}books/currentuser`, {
                headers: {
                    Authorization: `Bearer ${token}`,
                }
            })
                .then(response => {
                    const books = response.data;
                    books.sort((a, b) => b.id - a.id);
                    const booksList = document.getElementById('booksList');
                    booksList.innerHTML = ''; // Clear previous books
                    books.forEach(book => {
                        const bookItem = document.createElement('div');
                        bookItem.innerHTML = `<div>Name: ${book.name} - Author: ${book.author} - Year: ${book.year}</div>`;

                        // Create buttons for CRUD operations
                        const editButton = document.createElement('button');
                        editButton.textContent = 'Edit';
                        editButton.className = 'btn btn-primary mr-2';
                        editButton.onclick = () => editBook(book.id);
                        bookItem.appendChild(editButton);

                        const deleteButton = document.createElement('button');
                        deleteButton.textContent = 'Delete';
                        deleteButton.className = 'btn btn-danger';
                        deleteButton.onclick = () => deleteBook(book.id);

                        bookItem.appendChild(editButton);
                        bookItem.appendChild(deleteButton);

                        booksList.appendChild(bookItem);
                    });
                })
                .catch(error => {
                    Toastify({
                        text: 'Failed to fetch books',
                        backgroundColor: 'red',
                    }).showToast();
                    console.error('Books fetch error:', error);
                });
        }

        const addBook = async () => {
            const name = document.getElementById('name').value;
            const author = document.getElementById('author').value;
            const year = document.getElementById('year').value;
            const img = document.getElementById('img').value;

            const token = localStorage.getItem('token');
            if (!token) {
                Toastify({
                    text: 'Please login to perform this action',
                    backgroundColor: 'red',
                }).showToast();
                return;
            }

            const bookData = {
                name: name,
                author: author,
                year: parseInt(year), // Ensure year is converted to an integer
                img : img
            };
            console.log('Book data:', bookData);


            axios.post(`${MY_SERVER}books/`, bookData, {
                headers: {
                    Authorization: `Bearer ${token}`,
                    'Content-Type': 'application/json', // Set content type to JSON
                }
            })
                .then(response => {
                    console.log('Book added:', response.data);
                    Toastify({
                        text: 'Book added successfully',
                        backgroundColor: 'green',
                    }).showToast();
                    getBooks(); // Refresh the books list after adding a new book
                })
                .catch(error => {
                    if (error.response && error.response.status === 401) {
                        Toastify({
                            text: 'Please login to perform this action',
                            backgroundColor: 'red',
                        }).showToast();
                    } else {
                        Toastify({
                            text: 'Failed to add book',
                            backgroundColor: 'red',
                        }).showToast();
                        console.error('Add book error:', error);
                    }
                });
        }

        // CRUD operations

        // Function to handle editing a book
        const editBook = async (bookId) => {
            // Prompt the user to enter the updated book information
            const newName = prompt("Enter the new name for the book:");
            const newAuthor = prompt("Enter the new author for the book:");
            const newYear = prompt("Enter the new year for the book:");

            // Prepare the updated book data
            const updatedBookData = {
                name: newName,
                author: newAuthor,
                year: parseInt(newYear)
            };

            // Send a PUT request to update the book
            const token = localStorage.getItem('token');
            if (!token) {
                Toastify({
                    text: 'Please login to perform this action',
                    backgroundColor: 'red',
                }).showToast();
                return;
            }

            axios.put(`${MY_SERVER}books/${bookId}/`, updatedBookData, {
                headers: {
                    Authorization: `Bearer ${token}`,
                    'Content-Type': 'application/json',
                }
            })
                .then(response => {
                    Toastify({
                        text: 'Book updated successfully',
                        backgroundColor: 'green',
                    }).showToast();
                    getBooks(); // Refresh the books list after editing
                })
                .catch(error => {
                    if (error.response && error.response.status === 401) {
                        Toastify({
                            text: 'Please login to perform this action',
                            backgroundColor: 'red',
                        }).showToast();
                    } else {
                        Toastify({
                            text: 'Failed to update book',
                            backgroundColor: 'red',
                        }).showToast();
                        console.error('Edit book error:', error);
                    }
                });
        }

        function deleteBook(bookId) {
            const token = localStorage.getItem('token');
            if (!token) {
                Toastify({
                    text: 'Please login to perform this action',
                    backgroundColor: 'red',
                }).showToast();
                return;
            }

            axios.delete(`${MY_SERVER}books/${bookId}`, {
                headers: {
                    Authorization: `Bearer ${token}`,
                }
            })
                .then(response => {
                    Toastify({
                        text: 'Book deleted successfully',
                        backgroundColor: 'green',
                    }).showToast();
                    // Optionally, you may want to refresh the books list after deletion.
                    getBooks();
                })
                .catch(error => {
                    Toastify({
                        text: 'Failed to delete book',
                        backgroundColor: 'red',
                    }).showToast();
                    console.error('Delete book error:', error);
                });
        }

    // On page load, check if the user is already logged in and fetch books
    window.onload = function () {
            checkLoggedIn();
        };





const token = localStorage.getItem('token');

if (token) {
    // Decode the JWT token
    const decodedToken = JSON.parse(atob(token.split('.')[1]));
    const username = decodedToken.username;
    const email = decodedToken.email;
    const isSuperuser = decodedToken['superuser?']; // Since 'superuser?' contains special character, use bracket notation

    // Now you can use this information as needed, such as displaying it to the user
    console.log('Username:', username);
    console.log('Email:', email);
    console.log('Is Superuser?', isSuperuser);
} else {
    console.log('Token not found');
}


if (token) {
    try {
        // Decode the JWT token
        const decodedToken = JSON.parse(atob(token.split('.')[1]));

        // Access the expiration time
        const expirationTimeInSeconds = decodedToken.exp;
        const currentTimeInSeconds = Math.floor(Date.now() / 1000); // Convert current time to seconds

        // Calculate the time until expiration in seconds
        const timeUntilExpirationInSeconds = expirationTimeInSeconds - currentTimeInSeconds;

        // Convert seconds to minutes and hours
        const minutesUntilExpiration = Math.floor(timeUntilExpirationInSeconds / 60);
        const hoursUntilExpiration = Math.floor(minutesUntilExpiration / 60);

        // Now you can use this information as needed
        console.log('Minutes until access token expires:', minutesUntilExpiration);
        console.log('Hours until access token expires:', hoursUntilExpiration);
    } catch (error) {
        console.error('Error decoding token:', error);
    }
} else {
    console.log('Token not found');
}
    </script>
</body>

</html>